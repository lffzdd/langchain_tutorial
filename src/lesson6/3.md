å¥½ï¼Œè¿™ä¸€æ®µæˆ‘ä»¬ä¸å†åŠ æ–°åŠŸèƒ½ï¼Œä¸“é—¨**æ‹†å¼€â€œè®°å¿†â€è¿™å¨ä»£ç ï¼ŒæŠŠå®ƒæ°æˆåº•å±‚æµç¨‹**æ¥çœ‹ä¸€çœ¼ï¼Œè®©ä½ èƒ½åœ¨è„‘å­é‡Œç”»å‡ºè°ƒç”¨é“¾ï¼Œè€Œä¸æ˜¯è¢«å„ç§å°è£…ç»•æ™•ã€‚

ä½ ç°åœ¨å›°æƒ‘çš„ç‚¹ä¸»è¦æœ‰ä¸‰ä¸ªï¼š

1. æ˜æ˜ LCEL æå€¡ `a | b | c | d`ï¼ŒåŠ äº†è®°å¿†ä¹‹åçªç„¶æ•´å‡ºä¸ª `RunnableWithMessageHistory(â€¦)`ï¼Œé“¾å¥½åƒâ€œä¸çº¯â€äº†ã€‚
2. `InMemoryChatMessageHistory` è¯´æ˜¯å­˜å‚¨è®°å¿†ï¼Œä½†ä»£ç é‡Œæ²¡çœ‹åˆ°ä»»ä½•æ˜¾å¼çš„ `.add_xxx()`ã€‚
3. `config={"configurable": {"session_id": "xxx"}}` çœ‹èµ·æ¥åƒä¸ªå’’è¯­ï¼ŒçŸ¥é“å¤§æ¦‚ç”¨æ¥åŒºåˆ†ä¼šè¯ï¼Œä½†å…·ä½“æ˜¯æ€ä¹ˆæµåŠ¨çš„å®Œå…¨æ²¡è®²ã€‚

æˆ‘ä»¬å°±æŒ‰è¿™ä¸‰ä¸ªç‚¹æ¥æ‹†ï¼š

---

## 1. å…ˆæŠŠâ€œæ²¡è®°å¿†â€çš„é“¾æƒ³æ¸…æ¥šï¼šå®ƒåˆ°åº•åœ¨å¹²å˜›

æœ€åŸå§‹çš„ LCEL å†™æ³•ï¼Œå…¶å®åªæœ‰è¿™æ¡é“¾ï¼š

```python
prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ä¸­æ–‡åŠ©æ‰‹ã€‚"),
    ("human", "{input}"),
])
llm = deepseek  # æˆ– ChatOpenAI(...)
chain = prompt | llm | StrOutputParser()
```

**è¿™é‡Œçš„å…³é”®ï¼š**

* `chain.invoke({"input": "ä½ å¥½"})`
  åšçš„äº‹å°±æ˜¯ï¼š

  * ç”¨ `{"input": "ä½ å¥½"}` æ¸²æŸ“ prompt
  * æŠŠæ¸²æŸ“å¥½çš„ messages ä¼ ç»™ `llm`
  * æŠŠ `llm` çš„è¾“å‡ºä¸¢ç»™è§£æå™¨ã€‚

ğŸ‘‰ **æ²¡æœ‰ä»»ä½•å†å²**ï¼Œæ¯æ¬¡éƒ½æ˜¯â€œå•è½®å¯¹è¯â€ã€‚

å¦‚æœä½ æƒ³**æ‰‹åŠ¨åŠ å†å²**ï¼Œå…¶å®å°±æ˜¯è¿™æ ·ï¼š

```python
history_messages = [
    # è¿™é‡Œè‡ªå·±ç»´æŠ¤å†å²
    {"role": "user", "content": "æˆ‘å«é˜¿å¼º"},
    {"role": "assistant", "content": "å¥½çš„ï¼Œæˆ‘è®°ä½äº†"},
]

prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ä¸­æ–‡åŠ©æ‰‹ã€‚"),
    ("placeholder", "{history}"),  # æŠŠ history å¡åœ¨è¿™é‡Œ
    ("human", "{input}"),
])

chain = prompt | llm | StrOutputParser()

chain.invoke({
    "input": "æˆ‘æ˜¯è°ï¼Ÿ",
    "history": history_messages,
})
```

**åº•å±‚é€»è¾‘ï¼š**

* ä½ æ˜¾å¼æŠŠ `history_messages` å½“å˜é‡ä¼ è¿› promptã€‚
* æ¨¡å‹çœ‹åˆ°çš„æ˜¯ï¼šsystem + ä¸€å¨å†å² + å½“å‰ user è¿™ä¸€è½®ã€‚

**é—®é¢˜ï¼š**
æ¯ä¸€è½®éƒ½è¦ä½ è‡ªå·±ç»´æŠ¤ `history_messages`ï¼šè¿½åŠ  HumanMessage / AIMessageï¼Œç„¶åä¼ ç»™ä¸‹ä¸€è½®ï¼Œè¶…å•°å—¦ã€‚

---

## 2. InMemoryChatMessageHistory æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

å®ƒå°±æ˜¯ä½ åˆšåˆšé‚£ä¸ª `history_messages` çš„**OO ç‰ˆ**ï¼šå¸®ä½ æŠŠâ€œåˆ—è¡¨ç»´æŠ¤â€å°è£…äº†ä¸€ä¸‹ã€‚å¯ä»¥æƒ³è±¡å®ƒé•¿è¿™æ ·ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```python
class InMemoryChatMessageHistory:
    def __init__(self):
        self.messages: List[BaseMessage] = []

    def add_user_message(self, text: str):
        self.messages.append(HumanMessage(content=text))

    def add_ai_message(self, text: str):
        self.messages.append(AIMessage(content=text))

    def add_message(self, msg: BaseMessage):
        self.messages.append(msg)

    def get_messages(self) -> List[BaseMessage]:
        return self.messages
```

**æ³¨æ„ï¼š**

* å®ƒ**ç¡®å®æœ‰å­˜å‚¨**ï¼šå°±æ˜¯å†…éƒ¨çš„ `self.messages` åˆ—è¡¨ï¼›
* â€œæ²¡çœ‹åˆ°æ˜¾å¼è°ƒç”¨â€ï¼Œåªæ˜¯å› ä¸º**å¸®ä½ è°ƒç”¨çš„äººå˜æˆäº† RunnableWithMessageHistory**ï¼Œè€Œä¸æ˜¯ä½ è‡ªå·±ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

> ä¹‹å‰æ˜¯ä½ è‡ªå·± `.append()`ï¼Œ
> ç°åœ¨æ¢æˆâ€œè®°å¿†ä¸­é—´ä»¶â€å¸®ä½  `.add_xxx()` äº†ã€‚

---

## 3. RunnableWithMessageHistory å¹²çš„è„æ´»ç´¯æ´»æ˜¯ä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬å†™ä¸€ä¸ª**ç®€åŒ–ç‰ˆä¼ªå®ç°**ï¼š

```python
class MyRunnableWithHistory:
    def __init__(self, chain, get_history, input_key="input", history_key="history"):
        self.chain = chain
        self.get_history = get_history     # é€šè¿‡ config å†³å®šç”¨å“ªä»½è®°å¿†
        self.input_key = input_key
        self.history_key = history_key

    def invoke(self, input_dict, config=None):
        # 1. æ‰¾åˆ°æœ¬æ¬¡è¦ç”¨çš„ history å¯¹è±¡
        # çœŸå® LangChain é‡Œï¼Œä» config["configurable"]["session_id"] é‡Œå–
        session_id = config["configurable"]["session_id"]
        history = self.get_history(session_id)  # æ¯”å¦‚è¿”å› InMemoryChatMessageHistory å®ä¾‹

        # 2. æŠŠå†å²æ¶ˆæ¯å–å‡ºæ¥ï¼Œæ³¨å…¥åˆ°é“¾çš„è¾“å…¥é‡Œ
        history_messages = history.messages
        full_input = dict(input_dict)
        full_input[self.history_key] = history_messages

        # 3. è°ƒç”¨åŸå§‹é“¾ï¼ˆprompt | llm | parserï¼‰
        result = self.chain.invoke(full_input)

        # 4. æœ€åæŠŠæœ¬è½®çš„ user / ai å¯¹è¯å†™å› history
        user_text = input_dict[self.input_key]
        history.add_user_message(user_text)
        # è¿™é‡Œå·æ‡’ï¼šå‡è®¾ chain æœ€ç»ˆè¿”å›å­—ç¬¦ä¸²
        history.add_ai_message(result)

        return result
```

è¿™å°±æ˜¯ `RunnableWithMessageHistory` çš„æœ¬è´¨åŠ¨ä½œï¼š

1. **æ ¹æ® config å†³å®šç”¨å“ªä¸€ä»½è®°å¿†å¯¹è±¡**ï¼ˆmulti-session æ”¯æŒï¼‰ã€‚
2. **åœ¨è°ƒç”¨é“¾ä¹‹å‰**ï¼ŒæŠŠå†å²æ”¾åˆ° `{history: ...}` è¿™ä¸ªå˜é‡é‡Œã€‚
3. **åœ¨è°ƒç”¨é“¾ä¹‹å**ï¼ŒæŠŠæœ¬è½®å¯¹è¯å†™å›åˆ° history é‡Œã€‚

ä½ çœ‹åˆ°çš„è¿™è¡Œä»£ç ï¼š

```python
chain_with_memory = RunnableWithMessageHistory(
    chain,
    get_history,
    input_messages_key="input",
    history_messages_key="history"
)
```

å°±ç›¸å½“äºåœ¨ `chain` å¤–é¢å¥—äº†ä¸€ä¸ªå£³ï¼ŒæŠŠâ€œå†å²çš„è¯» / å†™â€ç»Ÿä¸€å°è£…èµ·æ¥äº†ã€‚

---

## 4. config åˆ°åº•æ€ä¹ˆæµåŠ¨ï¼Ÿâ€œsession_id å’’è¯­â€æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ

é…ç½®å¤§æ¦‚æ˜¯è¿™æ ·ç”¨çš„ï¼š

```python
config = {
    "configurable": {
        "session_id": "user-001"
    }
}

chain_with_memory.invoke({"input": "ä½ å¥½"}, config=config)
```

ç„¶ååœ¨ `RunnableWithMessageHistory` å†…éƒ¨ï¼Œå®ƒä¼šæŠŠè¿™ä¸ª config ä¼ ç»™ä½ æä¾›çš„ `get_history` å›è°ƒï¼š

```python
def get_history_from_config(config):
    session_id = config["configurable"]["session_id"]
    return store[session_id]
```

å®˜æ–¹å†™æ³•å¸¸è§æ˜¯è¿™ç§ï¼š

```python
store = {}

def get_history(session_id: str):
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

chain_with_memory = RunnableWithMessageHistory(
    chain,
    lambda cfg: get_history(cfg["configurable"]["session_id"]),
    input_messages_key="input",
    history_messages_key="history",
)
```

**å…³é”®ç‚¹ï¼š**

* `config` æ˜¯æ•´æ¡ LCEL é“¾çš„â€œæ—è·¯å‚æ•°â€ï¼ˆå…ƒä¿¡æ¯ï¼‰ï¼Œè·Ÿ `invoke` çš„ä¸šåŠ¡è¾“å…¥åˆ†å¼€ã€‚

  * ä¸šåŠ¡æ•°æ®ï¼š`{"input": "ä½ å¥½"}`
  * é…ç½®æ•°æ®ï¼š`{"configurable": {"session_id": "user-001"}}`
* `RunnableWithMessageHistory` æ‹¿åˆ° config åä¼šè°ƒç”¨ä½ æä¾›çš„å›è°ƒå‡½æ•°ï¼Œä»è€Œæ‰¾åˆ°â€œè¿™æ¬¡åº”è¯¥ç”¨å“ªä¸€ä»½ InMemoryChatMessageHistoryâ€ã€‚

è¿™æ ·ä¸€æ¥ï¼š

* æ¢ä¸€ä¸ª `session_id` å°±æ˜¯æ¢ä¸€ä¸ªè®°å¿†ç©ºé—´ï¼›
* ä½ å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šä¸ºæ¯ä¸ªç”¨æˆ·ç»´æŠ¤ç‹¬ç«‹çš„å¯¹è¯å†å²ï¼Œè€Œä¸ç”¨æ‰‹åŠ¨ if-elseã€‚

ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆï¼š

> `configurable.session_id` æ˜¯â€œé€‰ä¸­å“ªå—è„‘è¢‹æ¥è®°å¿†â€çš„å¼€å…³ã€‚

---

## 5. â€œé“¾ä¸å†æ˜¯ a|b|c|dâ€çš„æœ¬è´¨ï¼šå…¶å®è¿˜æ˜¯ï¼Œåªæ˜¯å¤šäº†ä¸€å±‚â€œåŒ…â€

ä»â€œæ•°å­¦ä¸Šâ€çœ‹ï¼š

```python
chain = prompt | llm | parser
```

åŠ è®°å¿†åä½ å¯ä»¥ç†è§£ä¸ºï¼š

```python
chain_core = prompt | llm | parser
chain_with_memory = memory_wrapper | chain_core
```

åªä¸è¿‡ LangChain æ²¡æŠŠ memory_wrapper ä¹Ÿå†™æˆ `|` è¿ç®—ï¼Œè€Œæ˜¯ç”¨ `RunnableWithMessageHistory(chain_core, ...)` è¿™ç§ OOP å†™æ³•ã€‚**é€»è¾‘ä¸Šè¿˜æ˜¯å‰åä¸¤å±‚**ï¼š

* å†…æ ¸ï¼šè´Ÿè´£â€œæ€ä¹ˆé—®æ¨¡å‹ï¼Œæ€ä¹ˆè§£æç­”æ¡ˆâ€ã€‚
* å¤–å£³ï¼šè´Ÿè´£â€œæ¯ä¸€è½®ä¹‹å‰ä¹‹åï¼Œæ€ä¹ˆè¯»/å†™å†å²â€ã€‚

å¦‚æœä½ å¾ˆæ‰§ç€â€œå…¨ LCEL é£æ ¼â€ï¼Œå¯ä»¥è„‘è¡¥æˆï¼š

```python
chain_with_memory = runnable_memory_wrapper | (prompt | llm | parser)
```

åªæ˜¯å®˜æ–¹åœ¨è¯­æ³•ä¸Šæ²¡æš´éœ²ä¸€ä¸ª `| memory(...)` è¿™æ ·çš„è¯­æ³•ç³–è€Œå·²ã€‚

---

## 6. æŠŠä¸€åˆ‡æ‹¼åœ¨ä¸€èµ·ï¼šæ‰‹å†™ä¸€ä¸ªä¸é  RunnableWithMessageHistory çš„ç‰ˆæœ¬

æ¥ä¸ªå®Œå…¨æ‰‹å†™çš„â€œå°è®°å¿†å¯¹è¯â€ï¼Œä½ çœ‹å®Œå°±èƒ½æŠŠå¿ƒé‡Œçš„çº¿æ‹é¡ºï¼š

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.2)

prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ä¸­æ–‡åŠ©æ‰‹ã€‚"),
    ("placeholder", "{history}"),
    ("human", "{input}"),
])

chain = prompt | llm | StrOutputParser()

# --- æ‰‹å†™â€œè®°å¿†â€ ---
history_messages = []

def talk(user_text: str) -> str:
    global history_messages

    # 1. è°ƒç”¨é“¾æ—¶ï¼ŒæŠŠ history æ¶ˆæ¯æ˜¾å¼ä¼ è¿›å»
    result = chain.invoke({
        "input": user_text,
        "history": history_messages,
    })

    # 2. æŠŠæœ¬è½®å¯¹è¯å†™å› history
    history_messages = history_messages + [
        HumanMessage(content=user_text),
        AIMessage(content=result),
    ]

    return result

print(talk("ä½ å¥½ï¼Œæˆ‘å«é˜¿å¼ºã€‚"))
print(talk("è¯·è®°ä½æˆ‘çš„åå­—ã€‚"))
print(talk("æˆ‘æ˜¯è°ï¼Ÿ"))
```

å¯¹æ¯” `RunnableWithMessageHistory` åšçš„äº‹ï¼Œå…¶å®å®Œå…¨åŒæ„ï¼Œåªæ˜¯ï¼š

* æ‰‹å†™ç‰ˆï¼šä½ æ˜¾å¼ç»´æŠ¤ `history_messages`ï¼›
* å®˜æ–¹ç‰ˆï¼š`InMemoryChatMessageHistory` + `RunnableWithMessageHistory` å¸®ä½ ç»´æŠ¤ï¼›
* `config.session_id`ï¼šå¸®ä½ æ”¯æŒâ€œå¤šç”¨æˆ·å¤šä¼šè¯å…±å­˜â€çš„åœºæ™¯ã€‚

---

## 7. æ€»ç»“ä¸€å¥è¯ç‰ˆ

* `InMemoryChatMessageHistory` = ä¸€ä¸ªç®€å•çš„â€œæ¶ˆæ¯åˆ—è¡¨å®¹å™¨â€ï¼Œ**ç¡®å®æœ‰å­˜å‚¨**ï¼Œåªæ˜¯è¯»å†™åŠ¨ä½œè¢«å°è£…æ‰äº†ã€‚
* `RunnableWithMessageHistory` = åœ¨é“¾å¤–é¢å¥—çš„ä¸€å±‚ï¼Œ**è´Ÿè´£**ï¼š

  * è°ƒç”¨å‰ï¼šæ ¹æ® `config` æ‰¾åˆ°å¯¹åº”çš„ historyï¼ŒæŠŠå®ƒæ³¨å…¥åˆ° `{history}` å ä½ç¬¦ï¼›
  * è°ƒç”¨åï¼šæŠŠè¿™è½®å¯¹è¯å†™å› historyã€‚
* `configurable.session_id` = ä¸€ä¸ªâ€œé€‰æ‹©å“ªä»½è®°å¿†â€çš„å‚æ•°ï¼Œè®©å¤šä¼šè¯ä¸ä¸²å†å²ã€‚

ä½ å¦‚æœæ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å¯ä»¥åšä¸€ä»¶å¾ˆå·¥ç¨‹åŒ–ã€ä¹Ÿå¾ˆèƒ½åŠ æ·±ç†è§£çš„äº‹ï¼š
**è‡ªå·±å®ç°ä¸€ä¸ªâ€œå†™å…¥ SQLite / Redis çš„ ChatMessageHistoryâ€ï¼Œç„¶åæŠŠå®ƒæ¥åˆ° RunnableWithMessageHistory ä¸Š**ï¼Œä½ å°±èƒ½å®Œå…¨æŠŠã€Œè®°å¿† = æŸç§å¤–éƒ¨å­˜å‚¨ + ä¸€ä¸ªè¯»å†™åè®®ã€è¿™ä»¶äº‹åƒé€ã€‚
